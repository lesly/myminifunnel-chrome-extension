var background=(function(){"use strict";function g(e){return e==null||typeof e=="function"?{main:e}:e}const s={serverUrl:"https://app.base44.com",appId:"6901efa51535"};let a=null,u=0;const T=30*1e3,m=g(()=>{console.log("[MMF] Background service worker started"),chrome.action.onClicked.addListener(async e=>{if(e.id)try{await chrome.tabs.sendMessage(e.id,{type:"TOGGLE_SIDEBAR"})}catch{await chrome.scripting.executeScript({target:{tabId:e.id},files:["content-scripts/sidebar.js"]}),setTimeout(async()=>{try{await chrome.tabs.sendMessage(e.id,{type:"TOGGLE_SIDEBAR"})}catch(o){console.error("[MMF] Failed to toggle sidebar:",o)}},100)}}),chrome.runtime.onMessage.addListener((e,o,t)=>{if(e.type==="AUTH_TOKEN_FOUND"){w(e.data),t({success:!0});return}if(e.type==="GET_EXTENSION_DATA")return l().then(r=>t({success:!0,data:r})).catch(r=>t({success:!1,error:r.message})),!0;if(e.type==="GET_AUTH_STATUS")return chrome.storage.local.get(["authToken","userData"],r=>{t({isConnected:!!r.authToken,user:r.userData})}),!0;if(e.type==="DISCONNECT")return chrome.storage.local.remove(["authToken","appId","serverUrl","userData"],()=>{a=null,t({success:!0})}),!0;if(e.type==="REFRESH_DATA")return a=null,u=0,l().then(r=>t({success:!0,data:r})).catch(r=>t({success:!1,error:r.message})),!0;if(e.type==="OPEN_APP"){chrome.tabs.create({url:"https://app.myminifunnel.com/extension-connect"}),t({success:!0});return}})});async function w(e){const{token:o,appId:t,serverUrl:r}=e;if(o){await chrome.storage.local.set({authToken:o,appId:t||s.appId,serverUrl:r||s.serverUrl});try{await l()}catch(p){console.error("[MMF] Initial fetch failed:",p)}}}async function l(){const e=Date.now();if(a&&e-u<T)return a;const{authToken:o,appId:t,serverUrl:r}=await chrome.storage.local.get(["authToken","appId","serverUrl"]);if(console.log("[MMF] Auth data:",{hasToken:!!o,appId:t,serverUrl:r}),!o)throw new Error("Not connected. Please open My Mini Funnel app first.");const p=r||s.serverUrl,M=t||s.appId,f=`${p}/api/apps/${M}/functions/getExtensionData`;console.log("[MMF] Calling:",f);const n=await fetch(f,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`,"X-Access-Token":o},body:JSON.stringify({})});if(console.log("[MMF] Response status:",n.status),!n.ok){const E=await n.text();throw console.error("[MMF] Error response:",E),n.status===401?(await chrome.storage.local.remove(["authToken","userData"]),new Error("Session expired. Please log in to My Mini Funnel again.")):new Error(`API error: ${n.status}`)}const d=await n.json();console.log("[MMF] Result:",d);const i=d.data||d;return a=i,u=e,i.user&&await chrome.storage.local.set({userData:i.user}),i}function k(){}globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome;function c(e,...o){}const y={debug:(...e)=>c(console.debug,...e),log:(...e)=>c(console.log,...e),warn:(...e)=>c(console.warn,...e),error:(...e)=>c(console.error,...e)};let h;try{h=m.main(),h instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw y.error("The background crashed on startup!"),e}return h})();
