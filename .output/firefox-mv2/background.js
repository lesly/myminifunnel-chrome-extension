var background=(function(){"use strict";function T(e){return e==null||typeof e=="function"?{main:e}:e}const s={serverUrl:"https://app.base44.com",appId:"6901efa51535"};let a=null,i=0;const g=30*1e3,w=T(()=>{console.log("[MMF] Background service worker started"),chrome.runtime.onMessage.addListener((e,o,t)=>{if(e.type==="AUTH_TOKEN_FOUND"){m(e.data),t({success:!0});return}if(e.type==="GET_EXTENSION_DATA")return l().then(r=>t({success:!0,data:r})).catch(r=>t({success:!1,error:r.message})),!0;if(e.type==="GET_AUTH_STATUS")return chrome.storage.local.get(["authToken","userData"],r=>{t({isConnected:!!r.authToken,user:r.userData})}),!0;if(e.type==="DISCONNECT")return chrome.storage.local.remove(["authToken","appId","serverUrl","userData"],()=>{a=null,t({success:!0})}),!0;if(e.type==="REFRESH_DATA")return a=null,i=0,l().then(r=>t({success:!0,data:r})).catch(r=>t({success:!1,error:r.message})),!0})});async function m(e){const{token:o,appId:t,serverUrl:r}=e;if(o){await chrome.storage.local.set({authToken:o,appId:t||s.appId,serverUrl:r||s.serverUrl});try{await l()}catch(p){console.error("[MMF] Initial fetch failed:",p)}}}async function l(){const e=Date.now();if(a&&e-i<g)return a;const{authToken:o,appId:t,serverUrl:r}=await chrome.storage.local.get(["authToken","appId","serverUrl"]);if(console.log("[MMF] Auth data:",{hasToken:!!o,appId:t,serverUrl:r}),!o)throw new Error("Not connected. Please open My Mini Funnel app first.");const p=r||s.serverUrl,k=t||s.appId,d=`${p}/api/apps/${k}/functions/getExtensionData`;console.log("[MMF] Calling:",d);const n=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`,"X-Access-Token":o},body:JSON.stringify({})});if(console.log("[MMF] Response status:",n.status),!n.ok){const y=await n.text();throw console.error("[MMF] Error response:",y),n.status===401?(await chrome.storage.local.remove(["authToken","userData"]),new Error("Session expired. Please log in to My Mini Funnel again.")):new Error(`API error: ${n.status}`)}const f=await n.json();console.log("[MMF] Result:",f);const u=f.data||f;return a=u,i=e,u.user&&await chrome.storage.local.set({userData:u.user}),u}function I(){}globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome;function c(e,...o){}const M={debug:(...e)=>c(console.debug,...e),log:(...e)=>c(console.log,...e),warn:(...e)=>c(console.warn,...e),error:(...e)=>c(console.error,...e)};let h;try{h=w.main(),h instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw M.error("The background crashed on startup!"),e}return h})();
